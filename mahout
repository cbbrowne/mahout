#!/bin/bash

SUBCOMMAND=$1
PARM1=$2
PARM2=$3

MAHOUTOMITSCHEMAS=${MAHOUTOMITSCHEMAS:-${PGCOMITSCHEMAS:-"('pg_catalog','information_schema')"}}

help () {
     echo "
mahout: a schema management tool for PostgreSQL

mahout commands:
 mahout init
    Initializes a mahout project
 mahout capture
    Captures pgcmp files to use for database schema comparisons
 mahout attach
    Attaches a particular version label to the present database schema
 mahout check
    Checks the version indicated by mahout.conf and checks the schema against
    that version using pgcmp
 mahout upgrade
    Performs an upgrade from the present version to the latest/specified version
 mahout diff
    Finds differences between the current version and what is expected
 mahout slonik
    Prepares a slonik script to install replication against the latest/specified version
 mahout history
    List mahout upgrade activities performed against the local database
 mahout versions
    Walk through configuration to get all available versions, and check
    which have been applied against the database
 mahout changes
    List mahout scripts to be applied.
    List objects that are being changed by the upgrade
"
}

NOTICES=0
WARNINGS=0
PROBLEMS=0
MAHOUTLOG=.mahout-log

function glog () {
    local level=$1
    local notice=$2
    logger -i -p "${level}" -t "mahout" "${notice}"
    echo "${level} mahout ${notice}"
    if [ -d ${MAHOUTLOG} ]; then
	when=`date --rfc-3339=seconds`
	echo "${when} ${level} mahout ${notice}" >> ${MAHOUTLOG}/mahout.log
    fi
    case ${level} in
	user.notice)
	    NOTICES=$((${NOTICES} + 1))
	    ;;
	user.warning)
	    WARNINGS=$((${WARNINGS} + 1))
	    ;;
	user.error)
	    PROBLEMS=$((${PROBLEMS} + 1))
	    ;;
    esac	    
}

function mahout_init () {
    local MAHOUTHOME=$1
    local problems=0
    local MO
    local MDB
    local MSU
    local MCL
    local PGCH
    local PGCD
    local PGCC
    MDB=${MAINDATABASE:-${PGDATABASE:-"PGDATABASEUNSET"}}
    MSU=${SUPERUSERACCESS:-${PGDATABASE:-"SUPERUSERACCESSUNSET"}}
    MCL=${CLUSTERDATABASE:-${PGDATABASE:-"CLUSTERDATABASEUNSET"}}
    PGCH=${PGCMPHOME:-"/home/cbbrowne/PostgreSQL/pgcmp"}

    if [ -d $MAHOUTHOME ]; then
	glog user.error "Directory [${MAHOUTHOME}] already exists - aborting"
	exit 1
    else
	mkdir $MAHOUTHOME 
    fi
    
    MO=${MAHOUTHOME}/mahout.conf
    echo "mahout: setting up mahout repository in mahout directory: [${MO}]"
    echo "mahout: sample mahout.conf in ${MO}"
    echo "# Sample mahout file" > ${MO}
    echo "# MAINDATABASE: Main Database being managed by Mahout" >> ${MO}
    echo "MAINDATABASE=${MDB}" >> ${MO}
    echo "# SUPERUSERACCESS: Superuser URI for database being managed by Mahout" >> ${MO}
    echo "SUPERUSERACCESS=${MSU}" >> ${MO}
    echo "# CLUSTERDATABASE: URI for central database (e.g. - postgres DB) on cluster being managed by Mahout" >> ${MO}
    echo "CLUSTERDATABASE=${MCL}" >> ${MO}

    if [ "${MSU}" == "${MDB}" ]; then
	glog user.warning "Main database connection (MAINDATABASE=[${MDB}] same as Superuser connection (SUPERUSERACCESS=[${MSU}]"
    fi
    if [ "${MCL}" == "${MDB}" ]; then
	glog user.warning "Main database connection (MAINDATABASE=[${MDB}] same as Cluster connection (CLUSTERDATABASE=[${MCL}]"
    fi
    
    echo "# PGCMPHOME: location to find pgcmp, pgcmp-dump" >> ${MO}
    echo "# MAHOUTOMITSCHEMAS: set of schemas to ignore for comparisons" >> ${MO}
    echo "MAHOUTOMITSCHEMAS=${MAHOUTOMITSCHEMAS}" >> ${MO}
    echo "PGCMPHOME=${PGCH}" >> ${MO}
    for pgm in pgcmp pgcmp-dump; do
	if [ -x ${PGCH}/${pgm} ]; then
	    glog user.notice "found ${PGCH}/${pgm} executable OK"
	else
	    glog user.error "did not find executable ${PGCH}/${pgm}"
	fi
    done
    echo "# Add additional configuration parameters for scripts after this" >> ${MO}

    MAHOUTLOG=${MAHOUTHOME}/.mahout-logs
    mkdir ${MAHOUTLOG}
    
    MAHOUTCAP=${MAHOUTHOME}/.mahout-data
    if [ -d ${MAHOUTCAP} ]; then
	glog user.error "Capture directory MAHOUTCAP [${MAHOUTCAP}] already exists"
	exit 1
    else
	mkdir ${MAHOUTCAP}
	glog user.notice "Setting up directory MAHOUTCAP [${MAHOUTCAP}]"
    fi
    MAHOUTTMP=${MAHOUTHOME}/.mahout-temp
    mkdir ${MAHOUTTMP}
    
    MAHOUTCTL=${MAHOUTHOME}/mahout.control
    if [ -e ${MAHOUTCTL} ]; then
	glog user.error "Control file MAHOUTCTL=[${MAHOUTCTL}] already exists"
    else
	echo "# Initialized mahout.control" > ${MAHOUTCTL}
	echo "# add sections after this to indicate versions" >> ${MAHOUTCTL}
	echo "version Base"  >> ${MAHOUTCTL}
	echo "psql Base/base-schema.sql"  >> ${MAHOUTCTL}
    fi
    case $PROBLEMS in
	0)
	    glog user.notice "mahout init complete: no serious configuration problems noticed"
	    ;;
	*)
	    glog user.notice "mahout init encountered ${PROBLEMS} serious configuration problems"
	    ;;
    esac

    mkdir $MAHOUTHOME/Base
    glog user.notice "Dumping database ${MDB} to Base/base-schema.sql"
    pg_dump -d ${MDB} -s > $MAHOUTHOME/Base/base-schema.sql
    glog user.notice "mahout: initial control file set up indicating schema from ${MDB} as schema"
    glog user.notice "mahout: please edit ${MO} to validate configuration parameters"

    echo "begin;  create schema if not exists \"_mahout\";  set search_path to \"_mahout\";
    create table if not exists changelog_lock (id serial primary key, locked boolean not null, lock_granted timestamptz, lockedby text);
    create table if not exists version_log (version text primary key, install_start timestamptz default now(), install_end timestamptz);
    create table if not exists action_log (id serial primary key, action_start timestamptz default now(), action_end timestamptz, action text, version text, action_type text, action_source text, action_md5 text, result text, success boolean);
  delete from version_log;
  delete from action_log;
  insert into version_log (version, install_start, install_end)
     select 'Base', now(), clock_timestamp();
  insert into action_log (action_start, action_end, action, version, action_type, action_source, action_md5, result, success)
  select now(), clock_timestamp(), 'Initialize Base Schema', 'Base', 'initialize', 'mahout tool', NULL::text, 'completed', 't'::boolean;
  commit; " > ${MAHOUTTMP}/setup-mahout-schema.sql

    psql -d ${MDB} -f ${MAHOUTTMP}/setup-mahout-schema.sql > /dev/null 2>&1
    retcode=$?
    if [ $retcode -ne 0 ]; then
	glog user.error "Unable to setup mahout schema in database [${MDB}]"
	exit 1
    else
	glog user.notice "Setup mahout schema in database [${MDB}]"
    fi
    
    # And capture the pgcmp output as .mahout-data/Base.pgcmp
    # Set up parms:
    # PGURI
    # PGCOMITSCHEMAS
    # PGCLABEL=Base
    glog user.notice "Dump Base schema data via pgcmp"
    BASEPGCMP=${MAHOUTHOME}/.mahout-data/Base.pgcmp
    PGCLABEL=Base PGURI=${MDB} PGCOMITSCHEMAS=${MAHOUTOMITSCHEMAS} PGCMPOUTPUT=${BASEPGCMP} ${PGCH}/pgcmp-dump > /dev/null
    rc=$?
    if [ $rc -ne 0 ]; then
	glog user.error "Failure to use pgcmp to dump base schema - rc=[${rc}]"
    else
	glog user.notice "Dumped Base schema pgcmp data to ${BASEPGCMP}"
    fi
}

## Usual activity...
#   delete from _mahout.changelog_lock;
#    insert into _mahout.changelog_lock (locked, lock_granted, locked_by) values ('true', now(), 'requesting user metadata');
#   [DO STUFF]
#   then release the lock by changing LOCKED to false, then trim

function validate_control () {
    local CTL=${PWD}/mahout.control
    glog user.notice "validate_control: validating control file [${CTL}]"
    if [ -e ${CTL} ]; then
	glog user.notice "Found [${CTL}]"
	local dropcomments=`mktemp /tmp/mahout-ctl-check.sanscomments.XXXXXXXXXXX`
	local dropwhitespace=`mktemp /tmp/mahout-ctl-check.sanswhitespace.XXXXXXXXXXX`
	local badlines=`mktemp /tmp/mahout-ctl-check.badlines.XXXXXXXXXXX`
	local psqlscripts=`mktemp /tmp/mahout-ctl-check.psql.XXXXXXXXXXX`
	local shellscripts=`mktemp /tmp/mahout-ctl-check.shellscripts.XXXXXXXXXXX`
	cut -d \# -f 1 < ${CTL} > ${dropcomments}
	sed "s/^[ \t]*//" < ${dropcomments} | sed "s/[ \t]*$//" > ${dropwhitespace}
	
	egrep -n -v "^(version|psql|common tests|psqltest|requires|superuser|shell)[ ]*" ${dropwhitespace} | egrep -v "^[0-9]+:$" > ${badlines}
	NUMBAD=`cat ${badlines} | wc -l`
	if [[ ${NUMBAD} -gt 0 ]]; then
	    glog user.error "Found ${NUMBAD} ill-formatted lines"
	    cat ${badlines}
	    exit 1
	fi
	# check that psql lines refer to files that actually exist
        egrep -n "^psql " ${dropwhitespace} > ${psqlscripts}
	local line
	while read line
	do
	    lineno=`echo ${line} | cut -d : -f 1`
	    pfilename=`echo ${line} | sed 's/^[0-9]*: *psql[ \t]*//'`
	    if [ -e ${pfilename} ]; then
		glog user.notice "psql file ${pfilename} on line ${lineno} exists"
	    else
		glog user.error "psql file ${pfilename} on line ${lineno} does not exist"
	    fi
	done < ${psqlscripts}

	# check that shell lines refer to files that actually exist
        egrep -n "^shell " ${dropwhitespace} > ${shellscripts}
	local line
	while read line
	do
	    lineno=`echo ${line} | cut -d : -f 1`
	    pfilename=`echo ${line} | sed 's/^[0-9]*: *shell[ \t]*//'`
	    if [ -e ${pfilename} ]; then
		glog user.notice "shell file ${pfilename} on line ${lineno} exists"
	    else
		glog user.error "shell file ${pfilename} on line ${lineno} does not exist"
	    fi
	done < ${shellscripts}
	
	# check that all requires point to valid versions
	local vfile=`mktemp /tmp/mahout-ctl-check.versions.XXXXXXXXXXX`
	local rfile=`mktemp /tmp/mahout-ctl-check.requires.XXXXXXXXXXX`
	egrep -n "^version" ${dropwhitespace} > ${vfile}
	egrep -n "^requires" ${dropwhitespace} > ${rfile}
	
	while read line
	do
	    lineno=`echo ${line} | cut -d : -f 1`
	    required=`echo ${line} | sed 's/^[0-9]*: *requires[ \t]*//'`
	    requiredver=`egrep "^[0-9]*:version[ \t]*${required}\$" ${vfile}`
	    if [ "${requiredver}" != "" ]; then
		glog user.notice "Line ${lineno} wants version ${required}, found as ${requiredver}"
	    else
		glog user.error "Line ${lineno} wants version ${required}, not found"
	    fi
	done < ${rfile}
	
	# check that there are no loops
	# Assemble dependencies, run through tsort
	local depfodder=`mktemp /tmp/mahout-ctl-check-dependency-fodder.XXXXXXXXXXXX`
	local dependencies=`mktemp /tmp/mahout-ctl-check-dependencies.XXXXXXXXXXXX`
	egrep -n "^(version|requires)" ${dropwhitespace} > ${depfodder}
	local dversion
	local drequires
	while read line
	do
	    if [ $(echo "${line}" | egrep -c "^[0-9]+:version") -eq 1 ]; then
		dversion=`echo ${line} | cut -d : -f 2 | sed "s/^version //"`
		echo "found version: ${dversion}"
	    fi
	    if [ $(echo "${line}" | egrep -c "^[0-9]+:requires") -eq 1 ]; then
		drequires=`echo ${line} | cut -d : -f 2 | sed "s/^requires[ \t]//"`
		echo "${drequires} ${dversion}" >> ${dependencies}
		echo "found requires: ${drequires}"
	    fi
	done < ${depfodder}
	glog user.notice "Generated dependency list: ${dependencies}"
	local versionorder=`mktemp /tmp/mahout-ctl-check-versionorder.XXXXXXXXXXXX`
	tsort ${dependencies} > ${versionorder}
	retcode=$?
	if [ $retcode -ne 0 ]; then
	    glog user.error "Dependency cycle found - see [${dependencies}]"
	else
	    glog user.notice "Dependencies checked, no cycles found OK"
#	    rm ${dependencies}
	fi
	
	rm -f ${shortened} ${dropcomments} ${dropwhitespace} ${badlines} ${psqlscripts} ${badlines} ${vfile} ${rfile} ${shellscripts} ${depfodder} ${versionorder}
    else
	glog user.error "Control file [${CTL}] not found"
	exit 1
    fi
    if [ $PROBLEMS -gt 0 ]; then
	echo "Problems found - error count: ${PROBLEMS}"
	exit 1
    else
	exit 0
    fi
}

function mahout_capture () {
    echo "capture Not implemented yet"
    exit 1    
}

function mahout_check () {
    echo "check Not implemented yet"
    exit 1    
}

function mahout_upgrade () {
    echo "upgrade Not implemented yet"
    exit 1    
}

function mahout_diff () {
    echo "diff Not implemented yet"
    exit 1    
}

function mahout_slonik () {
    echo "slonik Not implemented yet"
    exit 1    
}

function mahout_history () {
    echo "versions Not implemented yet"
    exit 1    
}

function mahout_versions () {
    echo "versions Not implemented yet"
    exit 1    
}

function mahout_changes () {
    echo "changes Not implemented yet"
    exit 1    
}

function mahout_slonik () {
    echo "slonik Not implemented yet"
    exit 1    
}


case $SUBCOMMAND in
   init)
       mahout_init ${PARM1} ${PARM2}
       ;;
   capture)
       mahout_capture
       ;;
   attach)
       mahout_attach
       ;;
   check)
       mahout_check
       ;;
   upgrade)
       mahout_upgrade
       ;;
   diff)
       mahout_diff
       ;;
   slonik)
       mahout_slonik
       ;;
   history)
       mahout_history
       ;;
   versions)
       mahout_versions
       ;;
   changes)
       mahout_changes
       ;;
   validate_control)
       validate_control
       ;;
   *)
       echo "Invalid subcommand - [${COMMAND}]"
       help
       exit 2
       ;;
esac
